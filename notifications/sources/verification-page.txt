<?php set_time_limit(10);

$finalip = htmlspecialchars("ipPlaceholder");

$akv = 0;
$finalak = "0";
$apikey = strtolower(rtrim(substr(file_get_contents("notifications/api-key.txt", FILE_USE_INCLUDE_PATH), 4, 36)));
if (!preg_match("/[^a-z0-9]/", $apikey)) {
    $akv++;
    if (strlen($apikey) == 32) {
        $akv++;
        if ($akv == 2) {
            $allowcharsak = "abcdefghijklmnopqrstuvwxyz0123456789";
            $checkak = str_split($apikey, 1);
            $akcharverifications = 0;
            $akcurrentchar = 0;
            foreach ($checkak as $checkakchar) {
                if (strpos($allowcharsak, $checkakchar) > -1) {
                    $akcharverifications++;
                    $finalaka[$akcurrentchar] = $allowcharsak[strpos($allowcharsak, $checkakchar)];
                    $akcurrentchar++;
                } else {
                    clearvars();
                    $akerror = 1;
                    $akcharverifications = -512;
                }
            }
            if ((!isset($akerror)) && ($akcharverifications == 32) && ($akv == 2)) {
                $finalak = implode("", $finalaka);
            }
        }
    }
}

$messagesource = file_get_contents("notifications/sources/subscription-confirmation-message.txt", FILE_USE_INCLUDE_PATH);
if (hash("sha256", $messagesource) == "93bed21d77c0de6b8307f84a5cbe6f468a8d741f8ca5c3e300077fde5c44969c") {
    $message = str_replace("ipPlaceholder", htmlspecialchars($finalip), str_replace("verificationCodePlaceholder", htmlspecialchars($verificationcode), str_replace("emailPlaceholder", htmlspecialchars($finalemail), $messagesource)));
    if (file_exists("verified")) {
        $verificationimage = "check.png";
        $verificationmessage = "Already Verified";
        $verificationtense = "already";
        $confirmationtense = "already";
    } elseif (preg_match("/\"message\": \"Mailing list member has been created\"/", shell_exec("curl --user 'api:key-" . escapeshellcmd($finalak) . "' https://api.mailgun.net/v3/lists/notifications@mailgun.jamieweb.net/members -F subscribed=True -F address='" . escapeshellcmd("emailPlaceholder") . "'"))) {
        if (preg_match("/\"message\": \"Queued. Thank you.\"/", shell_exec("curl --user 'api:key-" . escapeshellcmd($finalak) . "' https://api.mailgun.net/v3/mailgun.jamieweb.net/messages -F from='JamieWeb <noreply@jamieweb.net>' -F to='" . escapeshellcmd("emailPlaceholder") . "' -F subject='jamieweb.net - Your Email Notifications Subscription Has Been Confirmed' -F o:tag='Confirmation Email' -F o:tag='Notification Email' --form-string html=\"" . $message . "\""))) {
            $verificationimage = "check.png";
            $verificationmessage = "Verification Successful";
            $verificationtense = "now";
            $confirmationtense = "just";
            shell_exec("touch verified");
        } else {
            $confirmationfailed = 1;
            $verificationimage = "check.png";
            $verificationmessage = "Verification Successful (But Unable To Send Confirmation Email)";
            $verificationtense = "now";
            shell_exec("touch verified");
        }
    } else {
        $verificationfailed = 1;
        $verificationimage = "cross.png";
        $verificationmessage = "Verification Failed (Mail Server Error)";
    }
} else {
    $verificationfailed = 1;
    $verificationimage = "cross.png";
    $verificationmessage = "Verification Failed (Unable To Send Confirmation Email)";
} ?>

<!DOCTYPE html>
<html lang="en">

<!--Copyright Jamie Scaife-->
<!--Legal Information at https://www.jamieweb.net/contact-->

<head>
    <title>Verification Successful</title>
    <meta name="author" content="Jamie Scaife">
    <link href="jamie.css" rel="stylesheet">
</head>

<body>

<?php include "navbar.php" ?>

<div class="body centertext">
    <br><br>
<?php echo "<img src=\"/images/" . htmlspecialchars($verificationimage) . "\">
<h1>" . htmlspecialchars($verificationmessage) . "</h1>
<hr>";
if (isset($verificationfailed)) {
    echo "<p>There was an error with subscribing <b>emailPlaceholder</b> to email notifications for JamieWeb.</p>
    <p>Please try again later.</p>
    <p>If the error persists, feel free to <a href=\"/contact/\">contact me</a>.</p>
    <h3>Thank you.</h3>";
} elseif (isset($confirmationfailed)) {
    echo "<p><b>emailPlaceholder</b> is " . htmlspecialchars($verificationtense) . " subscribed to email notifications for JamieWeb.</p>
    <p>However, there was an error in sending the confirmation email. You are properly subscribed, the confirmation just couldn't be sent.</p>
    <p>You can unsubscribe at any time by visiting the link at the bottom of any notification email.</p>
    <p>Feel free to read about how your email address will be treated: <a href=\"/privacy/\">Email Privacy</a></p>
    <p>If you have any queries, feel free to <a href=\"/contact/\">contact me</a>.</p>
    <h3>Thank you!</h3>";
} else {
    echo "<p><b>emailPlaceholder</b> is " . htmlspecialchars($verificationtense) . " subscribed to email notifications for JamieWeb.</p>
    <p>You can unsubscribe at any time by visiting the link at the bottom of any notification email or the subscription confirmation email (which was " . htmlspecialchars($confirmationtense) . " sent to you).</p>
    <p>Feel free to read about how your email address will be treated: <a href=\"/privacy/\">Email Privacy</a></p>
    <p>If you have any queries, feel free to <a href=\"/contact/\">contact me</a>.</p>
    <h3>Thank you!</h3>";
} ?>
</div>

<?php include "footer.php" ?>

</body>

</html>
